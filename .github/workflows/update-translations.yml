name: Update translations

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  pull_request:
    
  push:
    branches: [ development ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  update-and-commit-text:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v1
      with:
        submodules: true
        
# buggy action: https://github.community/t5/GitHub-Actions/Checkout-of-a-bitbucket-org-fails/td-p/49485/jump-to/first-unread-message
#     - uses: actions/checkout@v2
#     - name: Checkout submodules
#       shell: bash
#       run: |
#         auth_header="$(git config --local --get http.https://github.com/.extraheader)"
#         git submodule sync --recursive
#         git -c "http.extraheader=$auth_header" -c protocol.version=2 submodule update --init --force --recursive --depth=1  
    
# only works on push
#     - name: filter
#       uses: docker://cdssnc/touched-github-action:latest
#       with:
#         args: "**cpp, **ui"    
    
    - name: update text for translation
      uses: Mudlet/lupdate-action@master
      with:
        args: -recursive ./src/ ./3rdparty/dblsqd/dblsqd ./3rdparty/edbee-lib/edbee-lib -ts ./translations/mudlet.ts
        
    - name: muffle line shuffling in updated text
      uses: Mudlet/xmlstarlet-action@master
      with:
        args: ed -P -L --delete //@line translations/mudlet.ts
        
    - name: GitHub Push
      uses: ad-m/github-push-action@v0.5.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: HEAD:refs/heads/translations/translation-updates
        force: true
      
# action "Commit to a branch and push" {
#   uses = "Mudlet/commit-action-branch@master"
#   needs = ["xmlstarlet"]
#   secrets = ["GITHUB_TOKEN"]
#   env = {
#     USERNAME = "mudlet-bot"
#     USEREMAIL = "info@mudlet.org"
#     BRANCH_NAME = "translations/translation-updates"
#   }
# }

#     - name: commit to a branch and push
#       uses: Mudlet/commit-branch-action@master
#       env:
#         USERNAME: mudlet-machine-account
#         USEREMAIL: admin@mudlet.org
#         BRANCH_NAME: translations/text-updates
#       with:
#         args: "(autocommit) Cleaned up XML file and removed all of the shuffled lines attributes"
