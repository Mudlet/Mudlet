version: 1.0.{build}
branches:
  only:
  - development    # build the default branch
  - /^release-.+/  # build release branches
  - /^Mudlet-.+/   # build release tags (yes, the option also applies to tags)

init:
# Not needed, this is done prior to cloning the project's git repository
#- cmd: mkdir C:\src\
# enable to debug build process on start
# - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

image: Visual Studio 2019

# We use CHERE_INVOKING: "yes" for each job so that the directory does not
# change on startup:
environment:
  global:
    CCACHE_DIR: "%APPVEYOR_BUILD_FOLDER%\\.ccache"
    # our appveyor cache size is 1G
    CCACHE_MAXSIZE: 1G
    CHERE_INVOKING: "yes"
  signing_password:
    secure: JJDxNdreMgNn/IOcY+UVmlaqgDT4a7vcxsY3nfcgWY4=
  DEPLOY_KEY_PASS:
    secure: hW5QUOPCZvXJB3eA3+E3HdaoNGGl5VDpm762J5XSc6k=
  DEPLOY_PATH:
    secure: XQhASAJJm4Owpu74K4jgL0gszN59XJnCAS27NG7CW5G1LSRSWRh/EhKiTD36DvSr
  DBLSQD_USER:
    secure: MzfNcBLZRfswzBQufoW4EV+9/tcG5vW+G6EVTyN6Glc=
  DBLSQD_PASS:
    secure: Bm5PLJjC39XmRC55RPGVP9c5CFxvWu2VorAAmu5QS38=
  matrix:
  - MSYSTEM: "MINGW32"
    QT_MAJOR_VERSION: "5"
    BUILD_CONFIG: "debug"
  - MSYSTEM: "MINGW64"
    QT_MAJOR_VERSION: "5"
    BUILD_CONFIG: "debug"
  - MSYSTEM: "MINGW64"
    QT_MAJOR_VERSION: "6"
    BUILD_CONFIG: "debug"
  - MSYSTEM: "MINGW32"
    QT_MAJOR_VERSION: "5"
    BUILD_CONFIG: "release"
  - MSYSTEM: "MINGW64"
    QT_MAJOR_VERSION: "5"
    BUILD_CONFIG: "release"
  - MSYSTEM: "MINGW64"
    QT_MAJOR_VERSION: "6"
    BUILD_CONFIG: "release"

# Temporarily abort the whole build if one job fails, but don't worry about the
# qt6 case:
matrix:
  - fast_finish: true
  - allow_failures:
    - QT_MAJOR_VERSION: "6"

# The build cache is restored before the install stage.

install:
  # Update MSYS2
  #C:\msys64\usr\bin\bash -lc "pacman --noconfirm -Syuu"  # Core update (in case any core packages are outdated)
  #C:\msys64\usr\bin\bash -lc "pacman --noconfirm -Syuu"  # Normal update
  # The MSYSTEM setting in the matrix controls which terminal this bash.exe runs
  # when it is invoked with the -l (login shell) option:
- C:\msys64\usr\bin\bash.exe -lc C:\\projects\\mudlet\\setup-windows-sdk.sh

#Not needed?
#before_build:
#- echo "ccache stats before building:"
#- ccache --zero-stats --show-stats --verbose

build_script:
- C:\msys64\usr\bin\bash.exe -lc C:\\projects\\mudlet\\build-mudlet-for-windows.sh

after_build:
#- echo "ccache stats after building:"
#- ccache --show-stats --verbose
- C:\msys64\usr\bin\bash.exe -lc C:\\projects\\mudlet\\package-mudlet-for-windows.sh

# before_test:
# Not used

# test_script:
# Not used

# before_deploy:
# Not used

# There does not appear to be deply_script handler

# after_deploy:
# Not used

# on_success:
# Not used

# on_failure:
# Not used

# enable to debug build process on completion
# on_finish:
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

cache:
  - .ccache

notifications:
