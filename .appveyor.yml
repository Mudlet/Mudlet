version: 1.0.{build}
init:
- cmd: mkdir C:\src\
environment:
  matrix:
  - QT_BASE_DIR: C:\Qt\5.6\mingw49_32
    MINGW_BASE_DIR: C:\Qt\Tools\mingw492_32
    MINGW_BASE_DIR_BASH: /c/Qt/Tools/mingw492_32
  - QT_BASE_DIR: C:\Qt\5.6\mingw49_32
    MINGW_BASE_DIR: C:\Qt\Tools\mingw530_32
    MINGW_BASE_DIR_BASH: /c/Qt/Tools/mingw530_32
  - QT_BASE_DIR: C:\Qt\5.9\mingw53_32
    MINGW_BASE_DIR: C:\Qt\Tools\mingw530_32
    MINGW_BASE_DIR_BASH: /c/Qt/Tools/mingw530_32
install:
- powershell ".\CI\appveyor.install.ps1"

build_script:
- cd C:\projects\mudlet-1\src
- SET PATH=C:\Program Files (x86)\CMake\bin;C:\Program Files\7-Zip;%QT_BASE_DIR%\bin;%MINGW_BASE_DIR%\bin;C:\MinGW\msys\1.0\bin;%PATH%
- qmake CONFIG+=release LIBPATH+=%MINGW_BASE_DIR_BASH%/bin INCLUDEPATH+=/c/Libraries/boost_1_63_0 INCLUDEPATH+=%MINGW_BASE_DIR_BASH%/include INCLUDEPATH+=%MINGW_BASE_DIR_BASH%/lib/include

- make -j 2

- cd release
- windeployqt.exe --release mudlet.exe
- COPY %MINGW_BASE_DIR%\lib\libyajl.dll .
- COPY C:\src\lua-5.1.5\src\lua51.dll .
- COPY C:\src\openssl-1.0.2l\libeay32.dll .
- COPY C:\src\openssl-1.0.2l\ssleay32.dll .
- COPY %MINGW_BASE_DIR%\bin\libzip-2.dll .
- COPY %MINGW_BASE_DIR%\bin\libhunspell-1.4-0.dll .
- COPY %MINGW_BASE_DIR%\bin\libpcre-1.dll .
- COPY %MINGW_BASE_DIR%\bin\libsqlite3-0.dll .
- COPY %MINGW_BASE_DIR%\bin\zlib1.dll .
- XCOPY /S /I /Q ..\mudlet-lua mudlet-lua
- COPY ..\*.dic .
- COPY C:\src\luazip-master\zip.dll .
- XCOPY /S /I /Q %MINGW_BASE_DIR%\lib\lua\5.1 .

- DEL /Q *.cpp
- DEL /Q *.o

after_build:
- C:\src\installbuilder-qt-installer.exe --mode unattended --unattendedmodeui none
- git clone https://github.com/keneanung/mudlet-installers.git C:\projects\installers
- cd C:\projects\installers\windows
- nuget install secure-file -ExcludeVersion

on_failure:
- cd C:\src
- bash -c "curl --upload-file ./verbose_output.log https://transfer.sh/verbose_output.log"

artifacts:
- path: src\release
  name: mudlet
